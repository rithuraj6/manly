{% extends "base.html" %}
{% block content %}

<div class="payment-confirm-wrapper">
    <div class="payment-confirm-container">
        <h2 class="page-title">Checkout</h2>

        <form method="POST" action="{% url 'place_order' %}" class="confirm-form">
            {% csrf_token %}

            <div class="main-content">
                <!-- Payment Method Section (Moved to top) -->
                <div class="payment-method-card">
                    <div class="section-header">
                        <h3 class="section-title">Payment Method</h3>
                        <span class="section-subtitle">Choose how you'd like to pay</span>
                    </div>

                    <div class="payment-options-grid">
                        <!-- Razorpay -->
                        <label class="payment-option">
                            <input type="radio" name="payment_method" value="razorpay" checked>
                            <div class="payment-option-content">
                                <div class="payment-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                        <line x1="1" y1="10" x2="23" y2="10"></line>
                                    </svg>
                                </div>
                                <div class="payment-info">
                                    <span class="payment-name">Online Payment</span>
                                    <span class="payment-desc">Cards, UPI, Wallets</span>
                                </div>
                                
                            </div>
                        </label>

                        <!-- COD -->
                        <label class="payment-option {% if not cod_allowed %}disabled{% endif %}">
                            <input
                                type="radio"
                                name="payment_method"
                                value="cod"
                                {% if not cod_allowed %}disabled{% endif %}
                            >
                            <div class="payment-option-content">
                                <div class="payment-icon">
                                    <!-- icon -->
                                     <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"> <line x1="12" y1="1" x2="12" y2="23"></line> <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path> </svg>
                                </div>
                                <div class="payment-info">
                                    <span class="payment-name">Cash on Delivery</span>
                                    <span class="payment-desc">
                                        {% if not cod_allowed %}
                                            Not available for orders above ₹5000
                                        {% else %}
                                            Pay when received
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </label>

                        <!-- Wallet (disabled) -->
                      <label class="payment-option {% if wallet_balance < total %}disabled{% endif %}">
                            <input
                                type="radio"
                                name="payment_method"
                                value="wallet"
                                {% if wallet_balance < total %}disabled{% endif %}
                            >
                            <div class="payment-option-content">
                                <div class="payment-icon">
                                    <!-- icon -->
                                
                                                            <!-- icon --><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"> <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"></path> <path d="M3 5v14a2 2 0 0 0 2 2h16v-5"></path> <path d="M18 12a2 2 0 0 0 0 4h4v-4Z"></path> </svg>
                                                
                                </div>
                                <div class="payment-info">
                                    <span class="payment-name">Wallet</span>
                                    <span class="payment-desc">
                                        {% if wallet_balance < total %}
                                            Insufficient balance (₹{{ wallet_balance }})
                                        {% else %}
                                            Wallet balance: ₹{{ wallet_balance }}
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </label>

                    </div>
                </div>
                 

                <!-- Delivery Address Section -->
                <div class="delivery-address-card">
                    <div class="section-header">
                        <h3 class="section-title">Delivery Address</h3>
                        <a href="#" class="edit-link">Change</a>
                    </div>
                    
                    <div class="address-content">
                        <div class="address-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                        </div>
                        <div class="address-details">
                            <strong class="recipient-name">{{ address.full_name }}</strong>
                            <p class="address-line">{{ address.address_line_1 }}, {{ address.city }}</p>
                            <p class="address-meta">{{ address.pincode }} • {{ address.phone }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Summary Sidebar -->
            <div class="order-summary-sidebar">
                <div class="summary-card">
                    <h3 class="summary-title">Order Summary</h3>

                    <div class="order-summary">
                        <div class="summary-row">
                            <span>Subtotal</span>
                            <span>₹{{ subtotal }}</span>
                        </div>

                        <div class="summary-row">
                            <span>Shipping</span>
                            <span class="shipping-value">
                                {% if shipping == 0 %}
                                    <span class="free-badge">FREE</span>
                                {% else %}
                                    ₹{{ shipping }}
                                {% endif %}
                            </span>
                        </div>

                        <div class="summary-row">
                            <span>Tax (GST 18%)</span>
                            <span>₹{{ tax }}</span>
                        </div>

                        <div class="summary-divider"></div>

                        <div class="summary-row total">
                            <strong>Total</strong>
                            <strong>₹{{ total }}</strong>
                        </div>
                    </div>

                    <button type="button" id="confirm-payment-btn" class="confirm-order-btn">
                        <span>Place Order</span>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                            <polyline points="12 5 19 12 12 19"></polyline>
                        </svg>
                    </button>

                    <div class="secure-message">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                        <span>Secure checkout powered by Razorpay</span>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<style>
/* Base Styles */
.payment-confirm-wrapper {
    min-height: calc(100vh - 200px);
    padding: 40px 20px;
    background: #ffffff;
}

.payment-confirm-container {
    max-width: 1200px;
    margin: 0 auto;
}

.page-title {
    font-size: 28px;
    font-weight: 600;
    color: #1a1a1a;
    margin: 0 0 32px 0;
    letter-spacing: -0.5px;
}

/* Form Layout */
.confirm-form {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 24px;
    align-items: start;
}

.main-content {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* Section Styles */
.payment-method-card,
.delivery-address-card {
    background: #ffffff;
    border: 1px solid #e8e8e8;
    border-radius: 12px;
    padding: 24px;
    transition: all 0.3s ease;
}

.payment-method-card:hover,
.delivery-address-card:hover {
    border-color: #d0d0d0;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
}

.section-header {
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.section-title {
    font-size: 16px;
    font-weight: 600;
    color: #1a1a1a;
    margin: 0;
}

.section-subtitle {
    font-size: 13px;
    color: #666;
    display: block;
    margin-top: 4px;
}

.edit-link {
    font-size: 14px;
    color: #1a1a1a;
    text-decoration: none;
    font-weight: 500;
    transition: opacity 0.2s;
}

.edit-link:hover {
    opacity: 0.7;
}

/* Payment Options Grid */
.payment-options-grid {
    display: grid;
    gap: 12px;
}

.payment-option {
    display: block;
    cursor: pointer;
    position: relative;
}

.payment-option input[type="radio"] {
    position: absolute;
    opacity: 0;
    pointer-events: none;
}

.payment-option-content {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 16px;
    background: #fafafa;
    border: 3px solid #e8e8e8;
    border-radius: 10px;
    transition: all 0.3s ease;
}

.payment-option:not(.disabled) input[type="radio"]:checked ~ .payment-option-content {
    background: #f5f5f5;
    border-color: #10d331ff;
}

.payment-option:not(.disabled):hover .payment-option-content {
    border-color: #27991cff;
}

.payment-option.disabled {
    cursor: not-allowed;
    opacity: 0.8;
}

.payment-icon {
    width: 44px;
    height: 44px;
    background: #f0f0f0ff;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    color: #1a1a1a;
    border: 0.5px solid #ff3a3aa6;
}

.payment-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.payment-name {
    font-size: 15px;
    font-weight: 600;
    color: #1a1a1a;
}

.payment-desc {
    font-size: 13px;
    color: #666;
}

.payment-badge {
    font-size: 11px;
    font-weight: 600;
    color: #1a1a1a;
    background: #ffffff;
    padding: 4px 10px;
    border-radius: 12px;
    border: 1px solid #e8e8e8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Delivery Address */
.address-content {
    display: flex;
    gap: 16px;
    align-items: flex-start;
}

.address-icon {
    width: 40px;
    height: 40px;
    background: #fafafa;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    color: #1a1a1a;
    border: 1px solid #e8e8e8;
}

.address-details {
    flex: 1;
}

.recipient-name {
    display: block;
    font-size: 15px;
    font-weight: 600;
    color: #1a1a1a;
    margin-bottom: 6px;
}

.address-line,
.address-meta {
    font-size: 14px;
    color: #666;
    margin: 3px 0;
    line-height: 1.5;
}

/* Order Summary Sidebar */
.order-summary-sidebar {
    position: sticky;
    top: 20px;
}

.summary-card {
    background: #fafafa;
    border: 1px solid #e8e8e8;
    border-radius: 12px;
    padding: 24px;
}

.summary-title {
    font-size: 16px;
    font-weight: 600;
    color: #1a1a1a;
    margin: 0 0 20px 0;
}

.order-summary {
    display: flex;
    flex-direction: column;
    gap: 14px;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
    color: #666;
}

.summary-row.total {
    font-size: 16px;
    color: #1a1a1a;
    padding-top: 4px;
}

.shipping-value {
    display: flex;
    align-items: center;
}

.free-badge {
    font-size: 12px;
    font-weight: 600;
    color: #16a34a;
    background: #f0fdf4;
    padding: 3px 8px;
    border-radius: 6px;
}

.summary-divider {
    height: 1px;
    background: #e8e8e8;
    margin: 6px 0;
}

/* Confirm Order Button */
.confirm-order-btn {
    width: 100%;
    padding: 14px 24px;
    background: #1a1a1a;
    color: #ffffff;
    font-size: 15px;
    font-weight: 600;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.3s ease;
    margin-top: 20px;
}

.confirm-order-btn:hover {
    background: #333333;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.confirm-order-btn:active {
    transform: translateY(0);
}

.confirm-order-btn svg {
    transition: transform 0.3s ease;
}

.confirm-order-btn:hover svg {
    transform: translateX(3px);
}

/* Secure Message */
.secure-message {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 16px;
    font-size: 12px;
    color: #666;
}

.secure-message svg {
    color: #666;
}

/* Responsive Design */
@media (max-width: 1024px) {
    .confirm-form {
        grid-template-columns: 1fr;
    }

    .order-summary-sidebar {
        position: static;
        order: -1;
    }
}

@media (max-width: 768px) {
    .payment-confirm-wrapper {
        padding: 24px 16px;
    }

    .page-title {
        font-size: 24px;
        margin-bottom: 24px;
    }

    .payment-method-card,
    .delivery-address-card {
        padding: 20px;
    }

    .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }

    .payment-option-content {
        padding: 14px;
    }

    .payment-icon {
        width: 40px;
        height: 40px;
    }

    .summary-card {
        padding: 20px;
    }
}
</style>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
document.getElementById("confirm-payment-btn").addEventListener("click", function () {
    const selectedMethod = document.querySelector(
        'input[name="payment_method"]:checked'
    ).value;

    // COD FLOW
    if (selectedMethod === "cod") {
        document.querySelector(".confirm-form").submit();
        return;
    }

    // WALLET FLOW
    if (selectedMethod === "wallet") {
        const form = document.createElement("form");
        form.method = "POST";
        form.action = "{% url 'wallet_payment' %}";

        const csrf = document.createElement("input");
        csrf.type = "hidden";
        csrf.name = "csrfmiddlewaretoken";
        csrf.value = "{{ csrf_token }}";

        form.appendChild(csrf);
        document.body.appendChild(form);
        form.submit();
        return;
    }

    // RAZORPAY FLOW
    if (selectedMethod === "razorpay") {
        fetch("{% url 'create_razorpay_order' %}", {
            method: "GET",
            headers: { "X-Requested-With": "XMLHttpRequest" }
        })
        .then(res => res.json())
        .then(data => {
            const options = {
                key: data.razorpay_key,
                amount: data.amount * 100,
                currency: "INR",
                order_id: data.razorpay_order_id,
                name: "MANLY",
                description: "Order Payment",

                handler: function (response) {
                    const form = document.createElement("form");
                    form.method = "POST";
                    form.action = "{% url 'verify_razorpay_payment' %}";

                    const csrf = document.createElement("input");
                    csrf.type = "hidden";
                    csrf.name = "csrfmiddlewaretoken";
                    csrf.value = "{{ csrf_token }}";

                    for (let key in response) {
                        const input = document.createElement("input");
                        input.type = "hidden";
                        input.name = key;
                        input.value = response[key];
                        form.appendChild(input);
                    }

                    form.appendChild(csrf);
                    document.body.appendChild(form);
                    form.submit();
                }
            };

            new Razorpay(options).open();
        });
    }
});
</script>

{% endblock %}