{% extends "base.html" %}
{% block content %}

<div class="checkout-wrapper">
    <div class="checkout-container">
        <h2 class="checkout-title">Checkout</h2>

        <form method="POST" action="{% url 'checkout_page' %}" novalidate>
            {% csrf_token %}

            <div class="checkout-grid">
                <!-- Left Column: Shipping Address -->
                <div class="checkout-main">
                    <div class="checkout-section">
                        <div class="section-header">
                            <h3 class="section-title">Shipping Address</h3>
                        </div>

                        <div class="address-selection">
                            {% for address in addresses %}
                                <label class="address-card {% if address.is_default %}selected{% endif %}">
                                    <input type="radio"
                                           name="address_id"
                                           value="{{ address.id }}"
                                           class="address-radio"
                                           {% if address.is_default %}checked{% endif %}>
                                    <div class="address-content">
                                        <div class="address-header">
                                            <div class="radio-indicator"></div>
                                            <strong class="address-name">{{ address.full_name }}</strong>
                                        </div>
                                        <div class="address-details">
                                           <p class="address-line"> {{ address.house_name }}, {{ address.street }}</p>
                                            <p class="address-line">{{ address.city }}, {{ address.pincode }}</p>
                                            <p class="address-phone">Phone: {{ address.phone }}</p>
                                        </div>
                                    </div>
                                </label>
                            {% empty %}
                                
                            {% endfor %}

                            <!-- Use New Address Option -->
                            <label class="address-card new-address-card">
                                <input type="radio"
                                    name="address_id"
                                    value="temporary"
                                    class="address-radio">
                                <div class="address-content">
                                    <div class="address-header">
                                        <div class="radio-indicator"></div>
                                        <div class="new-address-label">
                                            <strong class="address-name">Use a new address</strong>
                                            <span class="new-address-subtitle">Enter shipping details below</span>
                                        </div>
                                    </div>
                                </div>
                            </label>
                        </div>

                        <!-- Temporary Address Form -->
                        
                        <div id="temp-address-form" class="temp-address-form"
                            {% if temp_address_form %}style="display:block"{% endif %}>
                            <div class="form-header">
                                <h4 class="form-title">Shipping Details</h4>
                            </div>

                            <div class="form-grid">
                                <div class="form-group full-width">
                                    <input type="text"
                                        name="full_name"
                                        placeholder="Full Name"
                                        required
                                        pattern="[A-Za-z\s]+"
                                        value="{{ temp_address_form.full_name|default:'' }}">
                                </div>

                                <div class="form-group full-width">
                                    <input type="tel"
                                        name="phone"
                                        placeholder="Phone Number"
                                        required
                                        maxlength="10"
                                        pattern="[0-9]{10}"
                                        value="{{ temp_address_form.phone|default:'' }}">
                                </div>

                                <div class="form-group full-width">
                                    <input type="text"
                                        name="house_name"
                                        placeholder="House / Flat No."
                                        value="{{ temp_address_form.house_name|default:'' }}">
                                </div>

                                <div class="form-group full-width">
                                    <input type="text"
                                        name="street"
                                        placeholder="Street Address"
                                        value="{{ temp_address_form.street|default:'' }}">
                                </div>

                                <div class="form-group full-width">
                                    <input type="text"
                                        name="land_mark"
                                        placeholder="Landmark (optional)"
                                        value="{{ temp_address_form.land_mark|default:'' }}">
                                </div>

                                <div class="form-group">
                                    <input type="text"
                                        name="city"
                                        placeholder="City"
                                        value="{{ temp_address_form.city|default:'' }}">
                                </div>

                                <div class="form-group">
                                    <input type="text"
                                        name="state"
                                        placeholder="State"
                                        value="{{ temp_address_form.state|default:'' }}">
                                </div>

                                <div class="form-group">
                                    <input type="text"
                                        name="country"
                                        placeholder="Country"
                                        value="{{ temp_address_form.country|default:'' }}">
                                </div>

                                <div class="form-group">
                                    <input type="text"
                                        name="pincode"
                                        placeholder="Pincode"
                                        required
                                        maxlength="6"
                                        pattern="[0-9]{6}"
                                        value="{{ temp_address_form.pincode|default:'' }}">
                                </div>
                            </div>
                        </div>

                        {% if addresses %}
                            <a href="{% url 'account_address_add' %}?next=checkout" class="add-new-address-btn">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                Add Saved Address
                            </a>
                        {% endif %}
                    </div>
                </div>

                <!-- Right Column: Order Summary -->
                <div class="checkout-sidebar">
                    <div class="summary-card">
                        <h3 class="summary-title">Order Summary</h3>

                        <div class="order-summary">
                            <div class="summary-row">
                                <span>Items Subtotal</span>
                                <span>₹{{ subtotal }}</span>
                            </div>

                            {% if coupon %}
                                <div class="summary-row discount">
                                    <span>Coupon ({{ coupon.code }})</span>
                                    <span>-₹{{ coupon_discount }}</span>
                                </div>
                            {% endif %}

                            <div class="summary-row">
                                <span>Delivery Fee</span>
                                <span>
                                    {% if delivery_fee == 0 %}
                                        <span class="free-tag">Free</span>
                                    {% else %}
                                        ₹{{ delivery_fee }}
                                    {% endif %}
                                </span>
                            </div>

                            <div class="summary-row">
                                <span>Tax (18% GST)</span>
                                <span>₹{{ tax }}</span>
                            </div>

                            <div class="summary-divider"></div>

                            <div class="summary-row total">
                                <strong>Total Payable</strong>
                                <strong>₹{{ total_amount }}</strong>
                            </div>

                            <!-- Coupon Section -->
                            <div class="coupon-section">

                                    {% if eligible_coupons %}
                                        <div class="eligible-coupons">
                                            <p class="coupon-heading">Available Coupons</p>

                                            {% for c in eligible_coupons %}
                                                <div class="coupon-card">
                                                    <div class="coupon-left">
                                                        <span class="coupon-badge">CODE</span>
                                                        <span class="coupon-code">{{ c.code }}</span>
                                                        <p class="coupon-desc">{{ c.description }}</p>

                                                        {% if c.min_purchase_amount %}
                                                            <p class="coupon-min">
                                                                Min purchase: ₹{{ c.min_purchase_amount }}
                                                            </p>
                                                        {% endif %}
                                                    </div>


                                                    <button type="button"
                                                            class="copy-coupon-btn"
                                                            onclick="copyCoupon('{{ c.code }}')">
                                                        Copy
                                                    </button>
                                                </div>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                {% if coupon %}
                                    <button type="submit" formaction="{% url 'remove_coupon' %}"
                                        formmethod="post" class="remove-coupon-btn">
                                        Remove Coupon
                                    </button>
                                {% else %}
                                    <div class="coupon-input-group">
                                        <input type="text" name="coupon_code" class="coupon-input"
                                            placeholder="Enter coupon code">
                                        <button type="submit" formaction="{% url 'apply_coupon' %}"
                                            formmethod="post" class="apply-coupon-btn">
                                            Apply
                                        </button>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <button type="submit" class="checkout-submit-btn">
                            <span>Continue to Payment</span>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" 
                                stroke="currentColor" stroke-width="2">
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                                <polyline points="12 5 19 12 12 19"></polyline>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<style>
/* ================================
   COMPACT AVAILABLE COUPONS
   ================================ */

.eligible-coupons {
    margin-bottom: 1rem;
    padding: 0.9rem;
    background: var(--color-bg-tertiary);
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
}

.coupon-heading {
    font-size: 0.85rem;
    font-weight: 700;
    color: var(--color-text-primary);
    margin-bottom: 0.75rem;
}

/* Coupon Card */
.coupon-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.75rem;
   

    background: var(--color-bg-primary);
    border: 1px solid var(--color-border);
    border-left: 3px solid var(--color-primary);
    border-radius: var(--radius-md);
    padding: 0.65rem 0.75rem;

    margin-bottom: 0.5rem;
    transition: background 0.2s ease, box-shadow 0.2s ease;
}

.coupon-card:last-child {
    margin-bottom: 0;
}

.coupon-card:hover {
    background: rgba(206, 217, 240, 0.42);
    box-shadow: var(--shadow-sm);
}

/* Left Content */
.coupon-left {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.coupon-badge {
    font-size: 0.6rem;
    font-weight: 700;
    color: var(--color-primary);
    background: var(--color-primary-light);
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    width: fit-content;
    letter-spacing: 0.5px;
}

.coupon-code {
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--color-text-primary);
    font-family: monospace;
}

.coupon-desc {
    font-size: 0.75rem;
    color: var(--color-text-secondary);
    line-height: 1.3;
}

/* Minimum Purchase */
.coupon-min {
    font-size: 0.7rem;
    font-weight: 600;
    color: #b45309;
    background: rgba(245, 158, 11, 0.12);
    padding: 0.15rem 0.45rem;
    border-radius: 5px;
    width: fit-content;
    margin-top: 0.1rem;
}

/* Copy Button */
.copy-coupon-btn {
    padding: 0.35rem 0.85rem;
    font-size: 0.72rem;
    font-weight: 600;

    background: transparent;
    color: var(--color-primary);
    border: 1.5px solid var(--color-primary);
    border-radius: var(--radius-full);

    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.copy-coupon-btn:hover {
    background: var(--color-primary);
    color: #fff;
}

/* Mobile */
@media (max-width: 480px) {
    .coupon-card {
        flex-direction: column;
        align-items: flex-start;
        padding: 0.65rem;
    }

    .copy-coupon-btn {
        margin-top: 0.25rem;
        align-self: flex-start;
    }
}


/* ============================================
   COLOR PALETTE & VARIABLES
   ============================================ */
:root {
    --color-primary: #313131;
    --color-primary-dark: #1a1a1a;
    --color-primary-light: #7979793a;
    --color-success: #10b981;
    --color-danger: #ef4444;
    --color-text-primary: #0f172a;
    --color-text-secondary: #64748b;
    --color-text-muted: #94a3b8;
    --color-border: #e2e8f0;
    --color-bg-primary: #ffffff;
    --color-bg-secondary: #f8fafc;
    --color-bg-tertiary: #d8d8d8;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 16px;
    --radius-full: 9999px;
}

/* ============================================
   LAYOUT
   ============================================ */
.checkout-wrapper {
    min-height: calc(100vh - 200px);
    padding: 2.5rem 1.25rem;
    background: var(--color-bg-secondary);
}

.checkout-container {
    max-width: 1280px;
    margin: 0 auto;
}

.checkout-title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--color-text-primary);
    margin: 0 0 2rem 0;
}

.checkout-grid {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 2rem;
    align-items: start;
}

/* ============================================
   CHECKOUT SECTION
   ============================================ */
.checkout-section {
    background: var(--color-bg-primary);
    border-radius: var(--radius-lg);
    padding: 2rem;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--color-border);
}

.section-header {
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--color-bg-tertiary);
}

.section-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-text-primary);
    margin: 0;
}

/* ============================================
   ADDRESS CARDS
   ============================================ */
.address-selection {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-bottom: 1.25rem;
}

.address-card {
    position: relative;
    display: block;
    padding: 1.25rem;
    background: var(--color-bg-secondary);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s ease;
}

.address-card:hover {
    border-color: var(--color-primary);
    box-shadow: var(--shadow-md);
}

.address-card.selected {
    border-color: var(--color-primary);
    background: var(--color-primary-light);
}

.new-address-card {
    border-style: dashed;
}

.new-address-card.selected {
    border-style: solid;
}

.address-radio {
    position: absolute;
    opacity: 0;
    pointer-events: none;
}

.address-content {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.address-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.radio-indicator {
    width: 20px;
    height: 20px;
    border: 2px solid var(--color-text-muted);
    border-radius: 50%;
    position: relative;
    flex-shrink: 0;
    transition: all 0.2s ease;
}

.address-card.selected .radio-indicator,
.address-radio:checked ~ .address-content .radio-indicator {
    border-color: var(--color-primary);
}

.address-radio:checked ~ .address-content .radio-indicator::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 10px;
    height: 10px;
    background: var(--color-primary);
    border-radius: 50%;
}

.address-name {
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text-primary);
}

.new-address-label {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.new-address-subtitle {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    font-weight: 400;
}

.address-details {
    margin-left: 2rem;
}

.address-line,
.address-phone {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    margin: 0.25rem 0;
    line-height: 1.5;
}

/* ============================================
   TEMPORARY ADDRESS FORM
   ============================================ */
.temp-address-form {
    display: none;
    margin-top: 1.25rem;
    padding: 1.5rem;
    background: var(--color-bg-tertiary);
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
}

.form-header {
    margin-bottom: 1.25rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--color-border);
}

.form-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--color-text-primary);
    margin: 0;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-group input {
    padding: 0.875rem 1rem;
    font-size: 0.9375rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    background: var(--color-bg-primary);
    transition: all 0.2s ease;
    font-family: inherit;
    color: var(--color-text-primary);
}

.form-group input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px var(--color-primary-light);
}

.form-group input::placeholder {
    color: var(--color-text-muted);
}

/* ============================================
   ADD NEW ADDRESS BUTTON
   ============================================ */
.add-new-address-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: var(--color-bg-primary);
    color: var(--color-primary);
    border: 2px solid var(--color-primary);
    border-radius: var(--radius-full);
    font-weight: 600;
    font-size: 0.9375rem;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-top: 0.75rem;
}

.add-new-address-btn:hover {
    background: var(--color-primary);
    color: white;
}

/* ============================================
   ORDER SUMMARY
   ============================================ */
.checkout-sidebar {
    position: sticky;
    top: 2rem;
}

.summary-card {
    background: var(--color-bg-primary);
    border-radius: var(--radius-lg);
    padding: 2rem;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--color-border);
}

.summary-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-text-primary);
    margin: 0 0 1.5rem 0;
}

.order-summary {
    display: flex;
    flex-direction: column;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.875rem;
    font-size: 0.9375rem;
    color: var(--color-text-secondary);
}

.summary-row.discount {
    color: var(--color-success);
}

.summary-row.total {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--color-text-primary);
    margin-bottom: 0;
}

.summary-divider {
    height: 1px;
    background: var(--color-border);
    margin: 1rem 0;
}

.free-tag {
    display: inline-block;
    padding: 0.25rem 0.625rem;
    background: var(--color-success);
    color: white;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 600;
}

/* ============================================
   COUPON SECTION
   ============================================ */
.coupon-section {
    margin-top: 1.25rem;
    padding-top: 1.25rem;
    border-top: 1px solid var(--color-border);
}

.coupon-input-group {
    display: flex;
    gap: 0.5rem;
}

.coupon-input {
    flex: 1;
    padding: 0.75rem 1rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: 0.9375rem;
    font-family: inherit;
    color: var(--color-text-primary);
}

.coupon-input:focus {
    outline: none;
    border-color: var(--color-primary);
}

.apply-coupon-btn {
    padding: 0.75rem 1.5rem;
    background: var(--color-primary);
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: 0.9375rem;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.apply-coupon-btn:hover {
    background: var(--color-primary-dark);
}

.remove-coupon-btn {
    width: 100%;
    padding: 0.75rem 1rem;
    background: var(--color-bg-secondary);
    color: var(--color-danger);
    border: 1px solid var(--color-danger);
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: 0.9375rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.remove-coupon-btn:hover {
    background: var(--color-danger);
    color: white;
}

/* ============================================
   SUBMIT BUTTON
   ============================================ */
.checkout-submit-btn {
    width: 100%;
    padding: 1rem 1.5rem;
    background: var(--color-primary);
    color: white;
    font-size: 1rem;
    font-weight: 600;
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
    margin-top: 1.5rem;
}

.checkout-submit-btn:hover {
    background: var(--color-primary-dark);
    box-shadow: var(--shadow-lg);
}

.checkout-submit-btn svg {
    transition: transform 0.2s ease;
}

.checkout-submit-btn:hover svg {
    transform: translateX(4px);
}

/* ============================================
   RESPONSIVE
   ============================================ */
@media (max-width: 1024px) {
    .checkout-grid {
        grid-template-columns: 1fr;
    }

    .checkout-sidebar {
        position: static;
    }
}

@media (max-width: 768px) {
    .checkout-wrapper {
        padding: 1.5rem 1rem;
    }

    .checkout-title {
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .checkout-section,
    .summary-card {
        padding: 1.5rem;
    }

    .address-details {
        margin-left: 0;
    }

    .form-grid {
        grid-template-columns: 1fr;
    }

    .temp-address-form {
        padding: 1.25rem;
    }
}

@media (max-width: 480px) {
    .checkout-wrapper {
        padding: 1rem 0.75rem;
    }

    .checkout-section,
    .summary-card {
        padding: 1.25rem;
    }

    .coupon-input-group {
        flex-direction: column;
    }

    .apply-coupon-btn {
        width: 100%;
    }
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function () {

    const addressCards = document.querySelectorAll('.address-card');
    const radios = document.querySelectorAll('input[name="address_id"]');
    const tempForm = document.getElementById('temp-address-form');
    if (!tempForm) return;

    const tempInputs = tempForm.querySelectorAll('input');

    function disableTempInputs() {
        tempInputs.forEach(input => {
            input.disabled = true;
            input.required = false;
        });
    }

    function enableTempInputs() {
        tempInputs.forEach(input => {
            input.disabled = false;
            if (input.name !== "land_mark") {
                input.required = true;
            }
        });
    }

    // ===== Default state on page load =====
    const checkedRadio = document.querySelector('input[name="address_id"]:checked');

    if (checkedRadio && checkedRadio.value === 'temporary') {
        tempForm.style.display = 'block';
        enableTempInputs();
    } else {
        tempForm.style.display = 'none';
        disableTempInputs();
    }

    // ===== Card selection =====
    addressCards.forEach(card => {
        const radio = card.querySelector('.address-radio');

        card.addEventListener('click', function (e) {
            if (e.target.tagName === "INPUT") return;

            addressCards.forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');
            radio.checked = true;
            radio.dispatchEvent(new Event('change'));
        });
    });

    // ===== Radio change =====
    radios.forEach(radio => {
        radio.addEventListener('change', () => {
            if (radio.value === 'temporary') {
                tempForm.style.display = 'block';
                enableTempInputs();
            } else {
                tempForm.style.display = 'none';
                disableTempInputs();
            }
        });
    });

    // ===== Input validation (frontend) =====
    function allowOnlyLetters(input) {
        input.addEventListener("input", function () {
            this.value = this.value.replace(/[^a-zA-Z\s]/g, "");
        });
    }

    function allowOnlyNumbers(input) {
        input.addEventListener("input", function () {
            this.value = this.value.replace(/[^0-9]/g, "");
        });
    }

    ["full_name", "city", "state", "country"].forEach(name => {
        const field = tempForm.querySelector(`input[name="${name}"]`);
        if (field) allowOnlyLetters(field);
    });

    ["phone", "pincode"].forEach(name => {
        const field = tempForm.querySelector(`input[name="${name}"]`);
        if (field) allowOnlyNumbers(field);
    });

});


function copyCoupon(code) {
    const input = document.querySelector('.coupon-input');
    if (!input) {
        alert("Coupon input not found");
        return;
    }

    input.value = code;
    input.focus();

    // Optional UX feedback
    input.classList.add("copied");
    setTimeout(() => input.classList.remove("copied"), 800);
}
</script>


{% endblock %}